@extends('admin.layouts.app')

@section('title', 'Generate Page')

@section('content')
<div class="container">
    @if(session('result') || isset($result))
        @php
            $resultData = session('result') ?? $result;
        @endphp

        <!-- Alert Hasil Optimasi -->
        <div class="alert alert-success glass-alert">
            <h4>‚úÖ Hasil Optimasi:</h4>
            <p><strong>Rute:</strong> 
                @php
                    $idToNameMap = $destinasi->pluck('name', 'id')->toArray();
                    $routeNames = array_map(function($id) use ($idToNameMap) {
                        return $idToNameMap[$id] ?? $id;
                    }, $resultData['chromosome']);
                @endphp
                {{ implode(' ‚Üí ', $routeNames) }}
            </p>
            <p><strong>Total Jarak (OSRM):</strong> {{ $resultData['distance_km'] }} km</p>
            <p><strong>Waktu Generate:</strong> {{ $resultData['execution_time'] }}</p>
            <p><strong>Fitness:</strong> {{ number_format($resultData['fitness'], 6) }}</p>
        </div>

        <!-- Disclaimer -->
        <div class="alert alert-info glass-alert-info">
            <h5>‚ö†Ô∏è CATATAN PENTING TENTANG VISUALISASI RUTE:</h5>
            <div class="row">
                <div class="col-md-6">
                    <h6>üîµ GARIS BIRU (Jarak Udara):</h6>
                    <ul class="small">
                        <li>Menunjukkan jarak lurus antar destinasi</li>
                        <li>Dihitung menggunakan formula Haversine</li>
                        <li><strong>TIDAK mewakili rute yang bisa dilalui</strong></li>
                        <li>Mungkin melewati sungai, gunung, atau obstacle</li>
                        <li>Hanya untuk <strong>perbandingan jarak teoritis</strong></li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>üî¥ GARIS MERAH (Rute Sebenarnya):</h6>
                    <ul class="small">
                        <li>Menunjukkan rute yang bisa dilalui kendaraan</li>
                        <li>Dihitung dari data jalan via OSRM</li>
                        <li>Mempertimbangkan jembatan, jalan, dan obstacle</li>
                        <li><strong>GUNAKAN INI sebagai panduan perjalanan</strong></li>
                        <li>Data akurat dari peta jalan sebenarnya</li>
                    </ul>
                </div>
            </div>
            <p class="mb-0 mt-2"><strong>üí° Tips:</strong> Jika perbedaan jarak signifikan (contoh: Biru 8km, Merah 15km), artinya rute jalan memerlukan perputaran atau melewati jembatan.</p>
        </div>

        <div class="row">
            <!-- Map Container -->
            <div class="col-md-8">
                <div class="card glass-card shadow-lg mb-4">
                    <div class="card-header glass-header py-3">
                        <h6 class="m-0 font-weight-bold text-white">üó∫Ô∏è Visualisasi Rute</h6>
                    </div>
                    <div class="card-body p-0">
                        <div id="map" style="height: 600px;"></div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-md-4">
                <!-- Comparison Panel -->
                <div class="card glass-card shadow-lg mb-3">
                    <div class="card-header glass-header py-3">
                        <h6 class="m-0 font-weight-bold text-white">üìä Perbandingan Jarak</h6>
                    </div>
                    <div class="card-body">
                        <div id="distance-comparison">
                            <div class="comparison-loading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                                <p class="mt-2">Menghitung jarak...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Directions Panel -->
                <div class="card glass-card shadow-lg mb-4">
                    <div class="card-header glass-header py-3">
                        <h6 class="m-0 font-weight-bold text-white">üß≠ Petunjuk Arah</h6>
                    </div>
                    <div class="card-body p-0">
                        <div id="directions-panel" style="height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <form action="{{ route('optimasi.store') }}" method="POST">
            @csrf
            <input name="solusi" type="hidden" value="{{ json_encode($resultData['chromosome']) }}">
            <input name="jarak" type="hidden" value="{{ $resultData['distance_km'] }}">
            <button type="submit" class="btn btn-primary btn-lg btn-block glass-button mb-5">
                üíæ Simpan Data Optimasi
            </button>
        </form>
    @endif

    <!-- Form Generate -->
    <div class="card glass-card shadow-lg mb-4">
        <div class="card-header glass-header py-3">
            <h6 class="m-0 font-weight-bold text-white">‚öôÔ∏è Generate Optimasi Baru</h6>
        </div>
        <div class="card-body">
            <form action="{{ route('optimasi.generate.store') }}" method="post">
                @csrf
                <div class="form-row m-2">
                    <div class="col">
                        <label for="kromosom"><strong>Jumlah Kromosom</strong></label>
                        <input type="number" name="kromosom" class="form-control glass-input" value="10" placeholder="10" required>
                    </div>
                    <div class="col">
                        <label for="max_gen"><strong>Maksimal Generasi</strong></label>
                        <input type="number" name="max_gen" class="form-control glass-input" value="10" placeholder="10" required>
                    </div>
                    <div class="col">
                        <label for="titik_awal"><strong>Titik Awal</strong></label>
                        <select class="custom-select glass-input" name="titik_awal" required>
                            @foreach($destinasi as $des)
                                <option value="{{ $des->id }}">{{ $des->name }}</option>
                            @endforeach
                        </select>
                    </div>
                </div>

                <div class="form-row m-2">
                    <div class="col">
                        <label for="crossover_rate"><strong>Crossover Rate</strong></label>
                        <input type="text" value="0.8" name="crossover_rate" class="form-control glass-input" placeholder="0.8" required>
                    </div>
                    <div class="col">
                        <label for="mutation_rate"><strong>Mutation Rate</strong></label>
                        <input type="text" value="0.1" name="mutation_rate" class="form-control glass-input" placeholder="0.1" required>
                    </div>
                </div>
                
                <div class="form-row m-2">
                    <div class="col text-center">
                        <button type="submit" class="btn btn-primary btn-lg glass-button">
                            üöÄ Generate Rute Optimal
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Styles -->
<style>
/* Glassmorphism Theme */
.glass-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 15px;
    overflow: hidden;
}

.glass-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.glass-alert {
    background: rgba(212, 237, 218, 0.95);
    backdrop-filter: blur(10px);
    border-left: 4px solid #28a745;
    border-radius: 10px;
}

.glass-alert-info {
    background: rgba(217, 237, 247, 0.95);
    backdrop-filter: blur(10px);
    border-left: 4px solid #17a2b8;
    border-radius: 10px;
}

.glass-input {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(102, 126, 234, 0.3);
    border-radius: 8px;
    transition: all 0.3s ease;
}

.glass-input:focus {
    background: rgba(255, 255, 255, 1);
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.glass-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 10px;
    padding: 12px 30px;
    color: white;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.glass-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}

/* Map Controls */
.leaflet-control-custom {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(102, 126, 234, 0.3);
    border-radius: 10px;
    padding: 10px 15px;
    cursor: pointer;
    font-family: 'Nunito', sans-serif;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    margin: 10px;
    transition: all 0.3s ease;
}

.leaflet-control-custom:hover {
    background: rgba(255, 255, 255, 1);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

.leaflet-control-custom.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

/* Comparison Panel */
.comparison-item {
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 10px;
    transition: all 0.3s ease;
}

.comparison-blue {
    background: linear-gradient(135deg, rgba(33, 150, 243, 0.1) 0%, rgba(33, 150, 243, 0.2) 100%);
    border-left: 4px solid #2196F3;
}

.comparison-red {
    background: linear-gradient(135deg, rgba(244, 67, 54, 0.1) 0%, rgba(244, 67, 54, 0.2) 100%);
    border-left: 4px solid #F44336;
}

.comparison-diff {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.2) 100%);
    border-left: 4px solid #FFC107;
}

.comparison-loading {
    text-align: center;
    padding: 30px;
    color: #667eea;
}

/* Directions Panel */
#directions-panel {
    font-family: 'Nunito', sans-serif;
    font-size: 0.9em;
}

.route-summary {
    padding: 15px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    margin-bottom: 10px;
    font-weight: bold;
}

.direction-step {
    padding: 12px;
    border-bottom: 1px solid #e3e6f0;
    transition: all 0.2s ease;
}

.direction-step:hover {
    background: rgba(102, 126, 234, 0.05);
}

.step-distance {
    color: #858796;
    font-size: 0.85em;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.glass-card {
    animation: fadeIn 0.5s ease;
}

/* Marker Popup Custom */
.leaflet-popup-content-wrapper {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.leaflet-popup-tip {
    background: rgba(255, 255, 255, 0.95);
}
</style>

<!-- JavaScript -->
<script>
let map;
let markers = [];
let straightPolyline; // Polyline BIRU (garis lurus)
let routePolyline;    // Polyline MERAH (OSRM)
let isStraightVisible = true;
let isRouteVisible = true;

document.addEventListener('DOMContentLoaded', function() {
    @if(isset($result))
        initializeMap();
    @endif
});

function initializeMap() {
    const destinations = @json($destinasi);
    
    @if(isset($result) && isset($result['chromosome']))
        const route = @json($result['chromosome']);
    @else
        console.error('Result data not available');
        return;
    @endif
    
    // Convert route IDs ke koordinat
    const coordinates = route.map(id => {
        const destination = destinations.find(d => d.id == id);
        return {
            id: id,
            lat: parseFloat(destination.lat),
            lng: parseFloat(destination.lng),
            name: destination.name,
            description: destination.description,
            img: destination.img
        };
    });
    
    // Inisialisasi map
    map = L.map('map').setView([coordinates[0].lat, coordinates[0].lng], 12);
    
    // Tile layer dengan style modern
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19,
    }).addTo(map);
    
    // Buat markers
    createMarkers(coordinates);
    
    // Buat polyline BIRU (garis lurus)
    createStraightPolyline(coordinates);
    
    // Get route dari OSRM (polyline MERAH)
    getOSRMRoute(coordinates);
    
    // Fit bounds
    const bounds = L.latLngBounds(coordinates.map(c => [c.lat, c.lng]));
    map.fitBounds(bounds, { padding: [50, 50] });
}

function createMarkers(coordinates) {
    coordinates.forEach((coord, index) => {
        let markerColor = '#2196F3';
        if (index === 0) markerColor = '#4CAF50';
        if (index === coordinates.length - 1) markerColor = '#F44336';
        
        const customIcon = L.divIcon({
            className: 'custom-marker',
            html: `
                <div style="
                    background: ${markerColor};
                    width: 35px;
                    height: 35px;
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 14px;
                    transition: all 0.3s ease;
                ">
                    ${String.fromCharCode(65 + index)}
                </div>
            `,
            iconSize: [35, 35],
            iconAnchor: [17.5, 17.5],
        });
        
        const marker = L.marker([coord.lat, coord.lng], { icon: customIcon }).addTo(map);
        
        // Popup dengan foto
        const imgUrl = coord.img ? `{{ asset('storage/images/destinations/') }}/${coord.img}` : '';
        const popupContent = `
            <div style="min-width: 200px;">
                ${coord.img ? `<img src="${imgUrl}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;" onerror="this.style.display='none'">` : ''}
                <h6 style="margin: 0 0 8px 0; color: #667eea; font-weight: bold;">${coord.name}</h6>
                <p style="margin: 0 0 8px 0; font-size: 0.9em; color: #555;">${coord.description || 'Tidak ada deskripsi'}</p>
                <p style="margin: 0; font-size: 0.85em; color: #858796;">
                    <strong>Titik ${String.fromCharCode(65 + index)}</strong><br>
                    ${index === 0 ? 'üü¢ Titik Awal' : (index === coordinates.length - 1 ? 'üî¥ Titik Akhir' : 'üîµ Persinggahan ' + index)}
                </p>
            </div>
        `;
        
        marker.bindPopup(popupContent);
        
        // Click to zoom
        marker.on('click', function() {
            map.flyTo([coord.lat, coord.lng], 15, {
                animate: true,
                duration: 1.5
            });
        });
        
        markers.push(marker);
    });
}

function createStraightPolyline(coordinates) {
    const latlngs = coordinates.map(c => [c.lat, c.lng]);
    
    // Hitung total jarak Haversine
    let totalStraightDistance = 0;
    for (let i = 0; i < coordinates.length - 1; i++) {
        totalStraightDistance += haversineDistance(
            coordinates[i].lat, coordinates[i].lng,
            coordinates[i + 1].lat, coordinates[i + 1].lng
        );
    }
    
    straightPolyline = L.polyline(latlngs, {
        color: '#2196F3',
        weight: 4,
        opacity: 0.7,
        dashArray: '15, 10',
        smoothFactor: 1
    }).addTo(map);
    
    // Simpan untuk comparison panel
    window.straightDistance = totalStraightDistance / 1000; // ke km
}

function getOSRMRoute(coordinates) {
    const coordsString = coordinates
        .map(c => `${c.lng},${c.lat}`)
        .join(';');
    
    const osrmUrl = `{{ env('OSRM_SERVER_URL', 'https://router.project-osrm.org') }}/route/v1/driving/${coordsString}`;
    
    document.getElementById('directions-panel').innerHTML = 
        '<div class="text-center p-3"><div class="spinner-border text-primary"></div><p class="mt-2">Menghitung rute...</p></div>';
    
    fetch(osrmUrl + '?overview=full&steps=true&geometries=geojson')
        .then(response => response.json())
        .then(data => {
            if (data.code === 'Ok' && data.routes.length > 0) {
                const route = data.routes[0];
                const geometry = route.geometry;
                const latlngs = geometry.coordinates.map(coord => [coord[1], coord[0]]);
                
                routePolyline = L.polyline(latlngs, {
                    color: '#F44336',
                    weight: 5,
                    opacity: 0.8,
                    smoothFactor: 1
                }).addTo(map);
                
                // Simpan untuk comparison
                window.routeDistance = route.distance / 1000; // ke km
                
                // Update comparison panel
                updateComparisonPanel();
                
                // Add toggle buttons
                addToggleControls();
                
                // Display directions
                displayDirections(route, coordinates);
            } else {
                document.getElementById('directions-panel').innerHTML = 
                    '<div class="alert alert-warning m-2">‚ùå Tidak dapat menghitung rute</div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('directions-panel').innerHTML = 
                '<div class="alert alert-danger m-2">‚ùå Error: ' + error.message + '</div>';
        });
}

function haversineDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Radius bumi dalam meter
    const œÜ1 = lat1 * Math.PI / 180;
    const œÜ2 = lat2 * Math.PI / 180;
    const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
    const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
              Math.cos(œÜ1) * Math.cos(œÜ2) *
              Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c; // dalam meter
}

function updateComparisonPanel() {
    const straight = window.straightDistance || 0;
    const route = window.routeDistance || 0;
    const diff = route - straight;
    const diffPercent = straight > 0 ? ((diff / straight) * 100).toFixed(1) : 0;
    
    const html = `
        <div class="comparison-item comparison-blue">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>üîµ Jarak Udara</strong>
                    <p class="mb-0 small text-muted">Garis lurus (Haversine)</p>
                </div>
                <h4 class="mb-0 text-primary">${straight.toFixed(2)} km</h4>
            </div>
        </div>
        
        <div class="comparison-item comparison-red">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>üî¥ Rute Jalan</strong>
                    <p class="mb-0 small text-muted">Mengikuti jalan (OSRM)</p>
                </div>
                <h4 class="mb-0 text-danger">${route.toFixed(2)} km</h4>
            </div>
        </div>
        
        <div class="comparison-item comparison-diff">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>üìà Selisih</strong>
                    <p class="mb-0 small text-muted">Perbedaan jarak</p>
                </div>
                <div class="text-right">
                    <h4 class="mb-0 text-warning">${diff.toFixed(2)} km</h4>
                    <p class="mb-0 small text-muted">(+${diffPercent}%)</p>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('distance-comparison').innerHTML = html;
}

function addToggleControls() {
    // Toggle Straight Line
    const toggleStraight = L.control({ position: 'topright' });
    toggleStraight.onAdd = function(map) {
        const button = L.DomUtil.create('div', 'leaflet-control-custom active');
        button.innerHTML = 'üîµ Jarak Udara';
        button.id = 'toggle-straight';
        
        L.DomEvent.on(button, 'click', function() {
            if (isStraightVisible) {
                map.removeLayer(straightPolyline);
                button.classList.remove('active');
                button.style.opacity = '0.5';
            } else {
                straightPolyline.addTo(map);
                button.classList.add('active');
                button.style.opacity = '1';
            }
            isStraightVisible = !isStraightVisible;
        });
        
        return button;
    };
    toggleStraight.addTo(map);
    
    // Toggle Route
    const toggleRoute = L.control({ position: 'topright' });
    toggleRoute.onAdd = function(map) {
        const button = L.DomUtil.create('div', 'leaflet-control-custom active');
        button.innerHTML = 'üî¥ Rute Jalan';
        button.id = 'toggle-route';
        
        L.DomEvent.on(button, 'click', function() {
            if (isRouteVisible) {
                map.removeLayer(routePolyline);
                button.classList.remove('active');
                button.style.opacity = '0.5';
            } else {
                routePolyline.addTo(map);
                button.classList.add('active');
                button.style.opacity = '1';
            }
            isRouteVisible = !isRouteVisible;
        });
        
        return button;
    };
    toggleRoute.addTo(map);
}

function displayDirections(route, coordinates) {
    const panel = document.getElementById('directions-panel');
    let html = '';
    
    const totalDistance = (route.distance / 1000).toFixed(2);
    const totalDuration = Math.round(route.duration / 60);
    
    html += `
        <div class="route-summary">
            üìç Total: ${totalDistance} km<br>
            ‚è±Ô∏è Waktu: ${totalDuration} menit
        </div>
    `;
    
    route.legs.forEach((leg, legIndex) => {
        html += `<div style="padding: 12px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); margin: 5px 10px; border-radius: 8px; font-weight: bold;">
            ${coordinates[legIndex].name} ‚Üí ${coordinates[legIndex + 1].name}
        </div>`;
        
        leg.steps.forEach((step, stepIndex) => {
            const distance = (step.distance / 1000).toFixed(2);
            const instruction = step.maneuver.type === 'depart' ? 'üöó Mulai perjalanan' :
                               step.maneuver.type === 'arrive' ? 'üèÅ Tiba di tujuan' :
                               '‚û°Ô∏è ' + (step.name || 'Lanjutkan');
            
            html += `
                <div class="direction-step">
                    <div><strong>${stepIndex + 1}.</strong> ${instruction}</div>
                    <div class="step-distance">${distance} km</div>
                </div>
            `;
        });
    });
    
    panel.innerHTML = html;
}
</script>

@endsection